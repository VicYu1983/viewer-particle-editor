<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="../../../Autodesk-Forge-Viewer_v7.52/style.css">
    <script src="../../../Autodesk-Forge-Viewer_v7.52/viewer3D.js"></script>
    <script src="../../../lib/viewer3D_extensions.js"></script>
</head>

<body style="margin:0px">

    <div style="position: absolute; width:100%; height:100%" id="viewerDiv"></div>


    <script>

        const Particle = threejs.particle.system.Particle;
        const Emitter = threejs.particle.system.Emitter;
        const ParticleSystem = threejs.particle.system.ParticleSystem;

        let config = {
            extensions: [],
            disabledExtensions: {
                measure: false,
                section: false,
            },

            memory: {
                limit: 32 * 1024 //32 GB
            }
        };

        const viewerDiv = document.getElementById('viewerDiv');
        viewer = new Autodesk.Viewing.Viewer3D(viewerDiv);

        const options = {
            docid: "../../../assets/sample2/3d.svf",
            env: 'Local',
            offline: 'true',
            useADP: false
        };

        Autodesk.Viewing.Initializer(options, function () {
            viewer.start();
            viewer.loadModel(options.docid, undefined, onLoadSuccess, onLoadError);
        });

        const ps = ParticleSystem.getInstance();

        viewer.addEventListener(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, onModelLoaded);

        function onLoadSuccess() {
            viewer.setProgressiveRendering(true);
        }

        function onLoadError(event) {
            console.log('load fail');
        }

        let uniforms = undefined;

        function onModelLoaded() {
            console.log('等模型讀取完畢換材質才有作用');

            ps.setViewer(viewer);

            const p = new Particle(threejs.shaders.ShaderTool.getSpriteMesh(undefined, new threejs.shaders.ParticleSpriteShader()), new threejs.particle.system.ParticlePool());
            viewer.impl.matman().addMaterial("particle", p.proxy.material, true);

            p.deadAge = 2;

            p.addForce(new threejs.particle.system.forces.BasicForce(0.02, new THREE.Vector3(0, 0, -1)));
            // p.addForce(new THREE.Vector3(0, 0, -.02));
            // ps.addParticle(p);

            const e = new Emitter(threejs.shaders.ShaderTool.getSpriteMesh(undefined, new threejs.shaders.ParticleSpriteShader()));
            viewer.impl.matman().addMaterial("emitter", e.proxy.material, true);
            // e.spray.horizonAngle = -Math.PI / 2;
            e.spray.verticalAngle = Math.PI * .5;
            e.spray.horizonRandom = Math.PI * .4;
            e.spray.verticalRandom = Math.PI * .5;
            e.spray.force = 2;

            e.setParticle(p);
            // e.addForce(new THREE.Vector3(.001, 0, 0));
            e.spray.rate = 10;
            e.deadAge = 10;
            // e.sprayForce.z = (Math.random() - .5) * 2 * 0.01;
            ps.addParticle(e);

            // console.log(fragIds);

            var loader = new THREE.TextureLoader();
            loader.load('../../../assets/t1.png', function (t) {
                t.minFilter = THREE.LinearMipMapLinearFilter;
                t.magFilter = THREE.LinearFilter;
                p.proxy.material.uniforms.usingTex.value = 1;
                p.proxy.material.uniforms.colorTex.value = t;

                e.proxy.material.uniforms.usingTex.value = 1;
                e.proxy.material.uniforms.colorTex.value = t;
            });

            window.requestAnimationFrame(runAnimation)
        }

        var deltaTime = 0;
        var lastTimestamp = 0;

        function runAnimation(timestamp) {
            window.requestAnimationFrame(runAnimation)

            if (lastTimestamp == 0) lastTimestamp = timestamp;

            deltaTime = (timestamp - lastTimestamp);
            lastTimestamp = timestamp;

            if (ps) ps.update(deltaTime / 1000);

            // 如果沒有下這行的話，只有在畫面的視角有變動時，才會更新畫面
            viewer.impl.sceneUpdated(true)
        }
    </script>
</body>

</html>