<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="../../../Autodesk-Forge-Viewer_v7.52/style.css">
    <script src="../../../Autodesk-Forge-Viewer_v7.52/viewer3D.js"></script>
    <script src="../../../lib/viewer3D_extensions.js"></script>
</head>

<body style="margin:0px">

    <div style="position: absolute; width:100%; height:100%" id="viewerDiv"></div>

    <script>

        const particleManager = threejs.particle.Manager.getInstance();

        const viewerDiv = document.getElementById('viewerDiv');
        viewer = new Autodesk.Viewing.Viewer3D(viewerDiv);

        const options = {
            docid: "../../../assets/sample2/3d.svf",
            env: 'Local',
            offline: 'true',
            useADP: false
        };
        Autodesk.Viewing.Initializer(options, function () {
            viewer.start();
            viewer.loadModel(options.docid, undefined, onLoadSuccess, onLoadError);

            particleManager.setViewer(viewer);
        });

        viewer.addEventListener(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, onModelLoaded);

        function onLoadSuccess() {
            viewer.setProgressiveRendering(true);
        }

        function onLoadError(event) {
            console.log('load fail');
        }

        function onModelLoaded() {
            console.log('等模型讀取完畢換材質才有作用');

            // particleManager.importSystem()
            fetch('importFromEditorDemo3.json')
                .then(response => response.json())
                .then(data => {
                    particleManager.importSystem(data);
                    particleManager.playEffect("4122731010-810112-4279-9996-81213010117686415", 0, 0, 1);
                    particleManager.playEffect("4122731010-810112-4279-9996-81213010117686415", 1, 0, 0);
                    particleManager.playEffect("4122731010-810112-4279-9996-81213010117686415", -1, 0, 0);
                })
                .catch(error => console.error('Error fetching JSON:', error));

            fetch('importFromEditorDemo.json')
                .then(response => response.json())
                .then(data => {
                    particleManager.importSystem(data);
                    particleManager.playEffect("1521413113102-714610-41288-10121014-0941412149375152", 0, 0, 0);
                })
                .catch(error => console.error('Error fetching JSON:', error));
            window.requestAnimationFrame(runAnimation);
        }

        function runAnimation(timestamp) {
            window.requestAnimationFrame(runAnimation)

            particleManager.update(timestamp);

            // 如果沒有下這行的話，只有在畫面的視角有變動時，才會更新畫面
            viewer.impl.sceneUpdated(true)
        }


    </script>
</body>

</html>